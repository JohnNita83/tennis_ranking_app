{% extends "base.html" %}
{% block content %}
<head>
  <style>
    .star-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .star {
      font-size: 1.8rem;
      color: gray;
      text-decoration: none;
    }
    .star.active {
      color: gold;
    }
    .table td, .table th {
      white-space: nowrap;
    }
    .table-responsive {
      overflow-x: auto;
    }
    .table {
      width: auto;
    }
  </style>
</head>
<div class="container mt-4">

<div class="row g-3 mb-4">
  <!-- Select Player card (1/3 width) -->
  <div class="col-md-4 col-12">
    <div class="card h-100 w-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Select player</h5>
        <label for="playerSelect" class="form-label">Player</label>
        <select id="playerSelect" class="form-select"
                onchange="location.href='?player_id=' + this.value">
          <option value="">Select Player</option>
          {% for player in players %}
            <option value="{{ player.id }}"
              {% if player.id == selected_player_id %}selected{% endif %}>
              {{ player.name }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Add Player card (2/3 width, divided into 2 columns) -->
<div class="col-md-8 col-12">
  <div class="card h-100 w-100 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Add or manage player</h5>
      <div class="row g-2 align-items-end">

        <!-- New Player (own form) -->
        <div class="col-md-6">
          <form method="post" action="{{ url_for('stringing.add_player') }}">
            <label class="form-label">New Player</label>
            <div class="input-group">
              <input type="text" name="name" class="form-control" placeholder="Enter name" required>
              <button class="btn btn-success btn-sm">+ Player</button>
            </div>
          </form>
        </div>

        <!-- Current Player + delete (own form) -->
        <div class="col-md-6">
          {% if selected_player_id %}
            <form method="post" action="{{ url_for('stringing.delete_player', player_id=selected_player_id) }}"
                  onsubmit="return confirm('Are you sure you want to delete {{ selected_player.name }} and all associated stringing jobs?');">
              <label class="form-label">Current Player</label>
              <div class="input-group">
                <input type="text" class="form-control" value="{{ selected_player.name }}" readonly>
                <button class="btn btn-danger btn-sm">- Player</button>
              </div>
            </form>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
</div>

  {% if selected_player %}
  <h4 class="mt-3 mb-3">Rackets for 
    <span class="text-success">{{ selected_player.name }}</span>
  </h4>

  <div class="row g-3 mb-3">
  <!-- Select Racket card (1/3 width) -->
  <div class="col-md-4 col-12 order-2 order-md-1">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Select racket</h5>
        <label for="racketSelect" class="form-label">Racket</label>
        <select id="racketSelect" class="form-select"
                onchange="location.href='?player_id={{ selected_player_id }}&racket_id=' + this.value">
          <option value="">Select Racket</option>
          {% for racket in rackets %}
            <option value="{{ racket.id }}"
              {% if racket.id == selected_racket_id %}selected{% endif %}>
              {{ racket.make_model }} {% if racket.serial %}({{ racket.serial }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Add Racket card (2/3 width) -->
  <div class="col-md-8 col-12 order-1 order-md-2">
    <div class="card h-100 w-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Add racket</h5>
        <form method="post" action="{{ url_for('stringing.add_racket', player_id=selected_player_id) }}" class="row g-2 align-items-end">

          <!-- Make/Model -->
          <div class="col-md-6">
            <label class="form-label">Make/Model</label>
            <input type="text" name="make_model" class="form-control" placeholder="e.g. Wilson Blade" required>
          </div>

          <!-- Serial -->
          <div class="col-md-4">
            <label class="form-label">Serial (optional)</label>
            <input type="text" name="serial" class="form-control" placeholder="e.g. SN12345">
          </div>

          <!-- Add button -->
          <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">
              + Racket
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>


  {% if selected_racket_id %}
  {% if selected_racket %}
    <!-- Top row: title + buttons -->
    <div class="mt-3 mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <h4>
          Stringing for:<br>
          <span class="text-success">{{ selected_racket.make_model }}</span>
          {% if selected_racket.serial %}
            <small class="text-muted">({{ selected_racket.serial }})</small>
          {% endif %}
        </h4>

        <div class="d-flex gap-2">
          <!-- Edit racket button -->
          <button type="button" class="btn btn-warning btn-sm" onclick="toggleEditForm()">Edit Racket</button>

          <!-- Delete racket button -->
          <form method="post" action="{{ url_for('stringing.delete_racket', racket_id=selected_racket.id) }}"
                onsubmit="return confirm('Are you sure you want to delete {{ selected_racket.make_model }}? All stringing data will be removed!');"
                style="display:inline;">
            <button class="btn btn-danger btn-sm">Delete Racket</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit form card (hidden by default) -->
    <div id="editForm" class="col-12" style="display:none; margin:15px 0;">
      <div class="card h-100 w-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Edit Racket</h5>
          <form method="post" action="{{ url_for('stringing.edit_racket', racket_id=selected_racket.id) }}">
            <div class="row">
              <!-- Make/Model -->
              <div class="col-md-4 col-12 mb-2">
                <label for="make_model" class="form-label">Make/Model</label>
                <input type="text" class="form-control" id="make_model" name="make_model"
                      value="{{ selected_racket.make_model }}">
              </div>
              <!-- Serial -->
              <div class="col-md-4 col-12 mb-2">
                <label for="serial" class="form-label">Serial</label>
                <input type="text" class="form-control" id="serial" name="serial"
                      value="{{ selected_racket.serial }}">
              </div>
              <!-- Save button -->
              <div class="col-md-2 col-12 mb-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">Save</button>
              </div>
              <!-- Cancel button -->
              <div class="col-md-2 col-12 mb-2 d-flex align-items-end">
                <button type="button" class="btn btn-secondary w-100" onclick="toggleEditForm()">Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function toggleEditForm() {
        const form = document.getElementById("editForm");
        form.style.display = (form.style.display === "none") ? "block" : "none";
      }
    </script>
  {% endif %}


    <div class="row g-3 mb-3">
    <div class="table-responsive">
    <table class="table table-sm table-striped align-middle text-center">
        <thead class="table-dark">
        <tr>
            <th> </th>
            <th>Date</th>
            <th>Mains</th>
            <th>Gauge</th>
            <th>Tens (kg)</th>
            <th>Crosses</th>
            <th>Gauge</th>
            <th>Tens (kg)</th>
            <th style="padding-right:12px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- Blank row for adding a new record (now first row) -->
        <tr class="table-success">
          <form method="post" action="{{ url_for('stringing.add_stringing', racket_id=selected_racket_id) }}">
            <input type="hidden" name="racket_id" value="{{ selected_racket_id }}">
            <td></td>
            <td><input type="date" name="date" class="form-control" style="width:auto; max-width:100px; font-size:.875rem;" required></td>
            <td>
              <select name="mains" class="form-select string-select" data-target="mains">
                <option value="">Select String</option>
                {% for s in strings %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
                <option value="__new__">➕ Add new string…</option>
              </select>
            </td>
            <td><input type="text" name="m_gauge" class="form-control"></td>
            <td><input type="number" step="0.1" name="m_tension" class="form-control"></td>
            <td>
              <select name="crosses" class="form-select string-select" data-target="crosses">
                <option value="">Select String</option>
                {% for s in strings %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
                <option value="__new__">➕ Add new string…</option>
              </select>
            </td>
            <td><input type="text" name="c_gauge" class="form-control"></td>
            <td><input type="number" step="0.1" name="c_tension" class="form-control"></td>
            <td><button class="btn btn-success btn-sm">+</button></td>
          </form>
        </tr>

        <!-- Existing records -->
        {% for rec in selected_racket.stringing_records %}
        <tr id="row-{{ rec.id }}" class="{% if rec.favorite %}table-warning{% endif %}">
          <td>
            <form method="post" action="{{ url_for('stringing.toggle_favorite', record_id=rec.id) }}" class="d-inline">
              <button type="submit" class="star-btn">
                {% if rec.favorite %}
                  <span class="star active">&#9733;</span>
                {% else %}
                  <span class="star">&#9734;</span> 
                {% endif %}
              </button>
            </form>
          </td>
          <td style="font-size:.875rem; width:50px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            {{ rec.date | datetimeformat }}
          </td>
          <td style="font-size:.875rem;">{{ rec.mains }}</td>
          <td tyle="font-size:.875rem;">{{ rec.m_gauge }}</td>
          <td style="font-size:.875rem;">{{ rec.m_tension }}</td>
          <td style="font-size:.875rem;">{{ rec.crosses }}</td>
          <td style="font-size:.875rem;">{{ rec.c_gauge }}</td>
          <td style="font-size:.875rem;">{{ rec.c_tension }}</td>
          <td>
            <form method="post" action="{{ url_for('stringing.delete_stringing', record_id=rec.id) }}" 
                  class="d-inline"
                  onsubmit="return confirm('Are you sure you want to delete this stringing job?');">
              <button class="btn btn-danger btn-sm ps-2 pe-2">-</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    {% endif %}
  {% endif %}
</div>

<script>
document.querySelectorAll(".string-select").forEach(sel => {
    sel.addEventListener("change", function () {
        if (this.value === "__new__") {
            const newString = prompt("Enter new string name:");
            if (newString && newString.trim() !== "") {
                fetch("/add_string_name", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newString })
                })
                .then(() => location.reload());
            } else {
                this.value = "";
            }
        }
    });
});
</script>

{% endblock %}
