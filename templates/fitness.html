{% extends "base.html" %}
{% block content %}
<h4 style="padding:30px 0">Fitness Tracker</h4>

<style>
  /* Category header (first row) */
  th[colspan] {
    text-align: center;
    background-color: green;
    color: white;
    border-right: 1px solid white;
  }

  /* Make widths deterministic */
  table.fitness-table {
    table-layout: fixed;          /* respect <colgroup> widths */
    width: 100%;
    border-collapse: collapse;    /* cleaner borders */
  }

  /* Subcategory header (second row) */
  .subcategory-header th {
    text-align: center;
    border-right: 1px solid black;
    border-left: 1px solid black;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 4px;
  }

  /* Body cells: apply width behavior and truncation */
  .fitness-table td.subcell {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 4px;
    text-align: center;
  }

  /* Optional: center whole body row */
  .body-table { text-align: center; }

  @media (max-width: 600px) {
      .table-responsive td:first-child,
      .table-responsive th:first-child {
        position: sticky;
        left: 0;
      }
    }
    .help-cell { 
        background-color: green!important; 
        color: yellow!important; 
        cursor: pointer; 
        border-right: 1px solid white;
    } 
    .help-cell:hover { 
        background-color: darkgreen!important; 
    }
</style>

<div class="table-tour table-responsive table-drag-container" style="overflow-x: auto; white-space: nowrap;">
  <form method="POST" action="{{ url_for('fitness.add_entry') }}">
    <table class="table table-sm table-striped align-middle fitness-table">
      <!-- Column widths -->
      <colgroup>
        <col style="width: 150px;"> <!-- Date -->
        {% for subs in categories.values() %}
          {% for sub, _ in subs %}
            <col style="width: 100px;"> <!-- Subcategory columns -->
          {% endfor %}
        {% endfor %}
        <col style="width: 70px;"> <!-- Actions -->
      </colgroup>

      <thead>
        <!-- First row: Help + Categories -->
        <tr style="text-align: center">
            <th class="help-cell" data-bs-toggle="modal" data-bs-target="#helpModal"> Help </th>
            {% for cat, subs in categories.items() %}
            <th colspan="{{ subs|length }}">{{ cat }}</th>
            {% endfor %}
            <th></th>
        </tr>

        <!-- Second row: Date + Subcategories + Actions -->
        <tr class="subcategory-header">
            <th style="border-left:none!important">Date</th>
            {% for subs in categories.values() %}
            {% for sub, _ in subs %}
                <th>{{ sub }}</th>
            {% endfor %}
            {% endfor %}
            <th style="border-right:none!important">Actions</th>
        </tr>
        </thead>

      <tbody>
        <!-- Add row -->
        <tr class="table-success">
          <td class="subcell">
            <input type="date" name="date" value="{{ now.strftime('%Y-%m-%d') }}" required>
          </td>
          {% for cat, subs in categories.items() %}
            {% for sub, entry_type in subs %}
              <td class="subcell">
                <input type="text" name="{{ cat }}__{{ sub }}" placeholder="{{ entry_type }}">
              </td>
            {% endfor %}
          {% endfor %}
          <td class="subcell">
            <button type="submit" class="btn btn-success btn-sm">+</button>
          </td>
        </tr>

        <!-- Existing entries -->
        {% for row in rows %}
        <tr class="body-table">
          <td class="subcell">{{ row.date }}</td>
          {% for cat, subs in categories.items() %}
            {% for sub, entry_type in subs %}
              {% set key = cat + '__' + sub %}
              {% set val = row.get(key) %}
              {% set is_best = best_values.get(key) == val %}
              <td class="subcell {{ 'text-success fw-bold' if is_best }}">{{ val }}</td>
            {% endfor %}
          {% endfor %}
          <td class="subcell">
            <a href="{{ url_for('fitness.delete_entry', date=row.date) }}"
                class="btn btn-danger btn-sm"
                onclick="return confirm('Are you sure you want to delete this entry?');">−</a>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Exercise Rules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Kevin Fitness Assessment - Bootstrap layout -->
<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">

      <!-- Reaction -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Reaction</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>React Ball:</strong> Throw one by one reaction balls. Count how many catches from 40 balls. <em>(Best of 3)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Coordination -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Coordination</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Forehand volleys against wall:</strong> Count how many volleys in 30 sec. <em>(Best of 3)</em>
            </li>
            <li class="list-group-item">
              <strong>Backhand volleys against wall:</strong> Count how many volleys in 30 sec. <em>(Best of 3)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Agility -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Agility</h2>
        </div>
        <div class="card-body">
          <p class="mb-2">
            <strong>Spider drill:</strong> Place 4 balls in the corner of the gym mats and one opposite starting point in the centre of the mats (gym mat area is 6m wide × 4m long). Maximum speed collect one ball at a time and return it to the starting point before going for the next ball. <em>(Best of 2)</em>
          </p>
        </div>
      </section>

      <!-- Explosiveness -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Explosiveness</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Height jump:</strong> Measure the difference between standing reach and jump height. <em>(Best of 3)</em>
            </li>
            <li class="list-group-item">
              <strong>Length jump:</strong> Measure the distance from start line to nearest heel mark. <em>(Best of 3)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Balance -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Balance</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Left foot BOSU:</strong> Measure the time of balance on one leg. <em>(Best of 2)</em>
            </li>
            <li class="list-group-item">
              <strong>Right foot BOSU:</strong> Measure the time of balance on one leg. <em>(Best of 2)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Strength -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Strength</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Arm hold:</strong> Hold a 1kg medicine ball with both arms fully extended in front. Measure the time held horizontally. <em>(Best of 1 or 2)</em>
            </li>
            <li class="list-group-item">
              <strong>Lateral jumps:</strong> With both feet, jump over a hurdle left to right. Count how many in 30 sec. <em>(Best of 1 or 2)</em>
            </li>
            <li class="list-group-item">
              <strong>Plank:</strong> Hold plank position and record the time held in good posture. <em>(Best of 1)</em>
            </li>
            <li class="list-group-item">
              <strong>2kg medicine ball overhead throw:</strong> Measure the distance. <em>(Best of 3)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Speed -->
      <section class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Speed</h2>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>10m sprint:</strong> Measure time. <em>(Best of 1 or 2)</em>
            </li>
            <li class="list-group-item">
              <strong>20m sprint:</strong> Measure time. <em>(Best of 1 or 2)</em>
            </li>
          </ul>
        </div>
      </section>

      <!-- Endurance -->
      <section class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0 text-uppercase">Endurance</h2>
        </div>
        <div class="card-body">
          <p class="mb-2">
            <strong>800m (2 laps):</strong> Measure the full time to complete. <em>(Best of 1)</em>
          </p>
        </div>
      </section>

    </div>
  </div>
</div>

      </div>
    </div>
  </div>
</div>


<script>
  const dragContainer = document.querySelector('.table-drag-container');

  let isDown = false;
  let startX;
  let scrollLeft;

  dragContainer.addEventListener('mousedown', (e) => {
    isDown = true;
    startX = e.pageX - dragContainer.offsetLeft;
    scrollLeft = dragContainer.scrollLeft;
  });

  dragContainer.addEventListener('mouseleave', () => {
    isDown = false;
  });

  dragContainer.addEventListener('mouseup', () => {
    isDown = false;
  });

  dragContainer.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - dragContainer.offsetLeft;
    const walk = (x - startX);
    dragContainer.scrollLeft = scrollLeft - walk;
  });
</script>
{% endblock %}
