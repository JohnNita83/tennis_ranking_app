{% extends "base.html" %}
{% block content %}
<head>
  <style>
    .table-drag-container {
      overflow-x: auto;
      cursor: grab;
    }
    .table-drag-container:active {
      cursor: grabbing;
    }
    .table-tour {
        overflow-y: auto; 
        max-height: 90vh; 
      }
      .table-tour thead th {
        position: sticky;
        top: 0;
        background: #e9ecef;
        z-index: 5;
      }
    @media (max-width: 600px) {
      .table-responsive td:first-child,
      .table-responsive th:first-child {
        position: sticky;
        left: 0;
      }
      .table-tour td:nth-child(6),
      .table-tour th:nth-child(6) {
        position: sticky;
        left: 0;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .table-tour {
        overflow-y: auto; 
        max-height: 90vh;; 
      }
      .table-tour thead th {
        position: sticky;
        top: 0;
        background: #e9ecef;
        z-index: 5;
      }
    }
    .table-success-dark,
    .table-success-dark > td {
        background-color: #cad1f7 !important;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="card-title mb-3">Tournaments – {{ player_name }} ({{ age_group }})</h5>

    <form class="row g-2 mb-3" method="get" action="{{ url_for('tournaments') }}">
      <div class="col-12 col-md-4">
        <label class="form-label">Player name</label>
        <input
          type="text"
          name="player"
          class="form-control"
          value="{{ player_name }}"
        />
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Ranking Age Group</label>
        <select name="age_group" class="form-select">
          {% for ag in age_groups %}
          <option value="{{ ag }}" {% if ag == age_group %}selected{% endif %}>
            {{ ag }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
      </div>
    </form>

    <form class="row g-2 mb-3" method="post" action="{{ url_for('tournaments') }}">
      <input type="hidden" name="player_name" value="{{ player_name }}" />
      <input type="hidden" name="age_group" value="{{ age_group }}" />
      <input type="hidden" name="action" value="add_domestic" />
      <div class="col-12 col-md-4">
        <label class="form-label">Tournament ID (TI)</label>
        <input
          type="text"
          name="tournament_id"
          class="form-control"
          placeholder="E1D2AD7A-92B3-4D05-A73D-F3A66FD7C01F"
        />
      </div>
      <div class="col-12 col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-primary w-100">
          Add tournament
        </button>
      </div>
    </form>

    <form class="row g-2 mb-3" method="post" action="{{ url_for('tournaments') }}">
      <input type="hidden" name="player_name" value="{{ player_name }}" />
      <input type="hidden" name="age_group" value="{{ age_group }}" />
      <input type="hidden" name="action" value="add_international" />
      <div class="col-12 col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-warning w-100">
          Add international tournament
        </button>
      </div>
    </form>
  </div>
</div>

<div class="alert alert-info mb-3 text-muted">
      Current ranking: <strong>{{ latest_rank if latest_rank else "&mdash;"|safe }}</strong>
      & WTN: <strong>{{ latest_wtn|float|round(1) if latest_wtn else "&mdash;"|safe }}</strong>
      {% if latest_week %} ({{ latest_week }}){% endif %}<br>
      Best ranking: <strong>{{ best_rank if best_rank else "&mdash;"|safe }}</strong>
      {% if best_rank_week %} on week <strong>{{ best_rank_week }}</strong>{% endif %} <br>
      Best WTN: <strong>{{ best_wtn|float|round(1) if best_wtn else "&mdash;"|safe }}</strong>
      {% if best_wtn_week %} on week <strong>{{ best_wtn_week }}</strong>{% endif %}
    </div>

<div class="row mb-3">
  <!-- Summary: Won/Lost/Matches -->
  <div class="col-12 col-lg-4 mb-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-3">Match Summary</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-striped mb-0 text-center align-middle">
            <thead class="table-light">
              <tr>
                <th></th>
                <th>Won</th>
                <th>%</th>
                <th>Lost</th>
                <th>%</th>
                <th>Mts</th>
              </tr>
            </thead>
            {% if stat_summary %}
            <tbody>
              {% for label in ["singles", "doubles", "total"] %}
              <tr>
                <td>{{ label.capitalize() }}</td>
                <td class="fw-bold text-success">{{ stat_summary[label].won }}</td>
                <td class="text-success">{{ stat_summary[label].won_pct }}%</td>
                <td class="fw-bold text-danger">{{ stat_summary[label].lost }}</td>
                <td class="text-danger">{{ stat_summary[label].lost_pct }}%</td>
                <td>{{ stat_summary[label].total }}</td>
              </tr>
              {% endfor %}
            </tbody>
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary: Tournament categories count -->
<div class="col-12 col-lg-8 mb-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="card-title mb-3">Tournaments by Category</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-striped mb-0 text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Cat</th>
              {% for col_code, display_name in point_columns %}
                <th>{{ display_name }}</th>
              {% endfor %}
              <th>TOTAL</th>
            </tr>
          </thead>
          <tbody>
            <!-- No. row -->
            <tr>
              <td style="font-weight: bold;">Qty</td>
              {% set ns = namespace(total=0) %}
              {% for col_code, display_name in point_columns %}
                {% set count = cat_counts[col_code] %}
                <td>{{ "&mdash;"|safe if count == 0 else count }}</td>
                {% set ns.total = ns.total + (count or 0) %}
              {% endfor %}
              <td class="fw-bold">{{ ns.total }}</td>
            </tr>

            <!-- Pts row -->
            <tr>
              <td style="font-weight: bold;">Pts</td>
              {% set ns = namespace(total=0) %}
              {% for col_code, display_name in point_columns %}
                {% set pts = cat_points[col_code] %}
                <td>{{ "&mdash;"|safe if pts == 0 else pts }}</td>
                {% set ns.total = ns.total + (pts or 0) %}
              {% endfor %}
              <td class="fw-bold">{{ ns.total }}</td>
            </tr>

            <!-- Avg row -->
            <tr>
              <td style="font-weight: bold;">Avg</td>
              {% set ns = namespace(total_points=0, total_counts=0) %}
              {% for col_code, display_name in point_columns %}
                {% set pts = cat_points[col_code] %}
                {% set count = cat_counts[col_code] %}
                {% set avg = (pts // count) if count > 0 else 0 %}
                <td>{{ "&mdash;"|safe if avg == 0 else avg }}</td>
                {% set ns.total_points = ns.total_points + (pts or 0) %}
                {% set ns.total_counts = ns.total_counts + (count or 0) %}
              {% endfor %}
              {% set total_avg = (ns.total_points // ns.total_counts) if ns.total_counts > 0 else 0 %}
              <td class="fw-bold">{{ "&mdash;"|safe if total_avg == 0 else total_avg }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div>

<form method="post" action="{{ url_for('tournaments') }}">
  <input type="hidden" name="player_name" value="{{ player_name }}" />
  <input type="hidden" name="age_group" value="{{ age_group }}" />
  <input type="hidden" name="action" value="save" />

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="card-title mb-0">Tournament List</h6>
        <button type="submit" class="btn btn-sm btn-success">
          Save changes
        </button>
      </div>

      <h3>{{ player_name }} – {{ age_group }}</h3>

      <div class="d-flex gap-3 mb-3">

        <!-- Category Filter -->
        <div>
          <label class="form-label mb-0">Category</label>
          <select id="filter-category" class="form-select form-select-sm" style="width:140px;">
            <option value="">All</option>
            {% for col_code, display_name in point_columns %}
              <option value="{{ col_code }}">{{ display_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Status Filter -->
        <div>
          <label class="form-label mb-0">Status</label>
          <select id="filter-status" class="form-select form-select-sm" style="width:140px;">
            <option value="">All</option>
            <option value="Interest">Interest</option>
            <option value="Entered">Entered</option>
            <option value="Played">Played</option>
            <option value="W/D">W/D</option>
            <option value="Rank ↓">Rank ↓</option>
            <option value="Rank ↑">Rank ↑</option>
          </select>
        </div>

      </div>
      
      <div class="table-tour table-responsive table-drag-container" style="overflow-x: auto; white-space: nowrap;">
        <table class="table table-sm table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th></th>
              <th>#</th>
              <th>Week</th>
              <th>Start</th>
              <th>Finish</th>
              <th>Tournament</th>
              <th>Category</th>
              <th>Opens</th>
              <th>Close</th>
              <th>Status</th>
              <th>Place</th>
              <th>Points</th>
              <th>Rnk points</th>
              <th>Rank</th>
              <th>+/-</th>
              <th>↑↓</th>
              <th>Won</th>
              <th>Lost</th>
              <th>Mts</th>
              <th>Event</th>
              <th>Ent.</th>
              <th>Draw</th>
              <th>View</th>
              <th>Player</th>
              <th>Mts.</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            {% set min_rank = rows | map(attribute='rank') | reject('equalto', None) | min %}
            {% set status = r.status %} 
            {% set row_class = "" %} 
            
            {% if status == "Entered" %} 
              {% set row_class = "table-warning" %} 
            {% elif status == "Played" and not r.is_international %} 
              {% set row_class = "table-success" %} 
            {% elif status == "Played" and r.is_international %} 
              {% set row_class = "table-success-dark" %} 
            {% elif status in ["W/D", "Rank ↓", "Rank ↑"] %} 
              {% set row_class = "table-danger" %} 
            {% endif %}
            <tr class="{{ row_class }}"
                data-category="{{ r.cat_code }}"
                data-status="{{ r.status }}">
              <td>
                <form
                  method="post"
                  action="{{ url_for('delete_tournament', row_id=r.id) }}"
                  onsubmit="return confirm('Delete this tournament?');"
                >
                  <input type="hidden" name="player_name" value="{{ player_name }}" />
                  <input type="hidden" name="age_group" value="{{ age_group }}" />
                  <form method="post" 
                        onsubmit="return confirm('Are you sure you want to delete this category?');">
                    <button type="submit" name="action" value="delete_category" 
                            class="btn btn-danger btn-sm ps-1 pe-1 ms-1 me-1">
                      <i class="bi bi-trash text-white"></i>
                    </button>
                  </form>
                </form>
              </td>
              <td style="font-size: .875rem; text-align: center;">{{ r.no }}</td>
              <td class="fw-bold ps-2 pe-2 text-success" style="font-size: .875rem; text-align: center;">{{ r.week }}</td>
              <td style="font-size: .875rem;">
                <span class="date-display" onclick="toggleEdit(this)">
                  {% if r.start_weekday %}
                    <strong>{{ r.start_weekday }}</strong> {{ r.start_date_part }}
                  {% else %}
                    Start Date
                  {% endif %}
                </span>
                <input type="date"
                      class="date-edit d-none"
                      name="start_{{ r.id }}"
                      value="{{ r.start_date or '' }}"
                      style="width:auto; max-width:120px;"
                      onblur="toggleEdit(this)">
              </td>

              <td style="font-size: .875rem;">
                <span class="date-display" onclick="toggleEdit(this)">
                  {% if r.end_weekday %}
                    <strong>{{ r.end_weekday }}</strong> {{ r.end_date_part }}
                  {% else %}
                    End Date
                  {% endif %}
                </span>
                <input type="date"
                      class="date-edit d-none"
                      name="finish_{{ r.id }}"
                      value="{{ r.end_date or '' }}"
                      style="width:auto; max-width:120px;"
                      onblur="toggleEdit(this)">
              </td>

              <td>
                {% set name = r.tournament_name or '' %}
                {% set ch_len = name|length %}
                <input type="text"
                      name="name_{{ r.id }}"
                      value="{{ name }}"
                      class="form-control form-control-sm"
                      size="{{ ch_len }}"
                      style="width: 30ch; padding-right:0px;">
              </td>

              <td style="font-size: .875rem;">
                <input type="hidden" name="row_id" value="{{ r.id }}" />
                <select
                  name="cat_{{ r.id }}"
                  class="form-select form-select-sm"
                  style="width:95px;"
                >
                  {% set options = international_columns if r.is_international else domestic_columns %}
                  {% for col_code, display_name in options %}
                    <option value="{{ col_code }}"
                      {% if r.cat_code %}
                        {% if r.cat_code == col_code %}selected{% endif %}
                      {% else %}
                        {% if loop.first %}selected{% endif %}
                      {% endif %}
                    >{{ display_name }}</option>
                  {% endfor %}
                </select>
              </td>
            
              <td style="font-size: .875rem;">
                <input type="date" name="opens_{{ r.id }}" value="{{ r.opens_date or '' }}" style="width:auto; max-width:100px;">
              </td>

              <td style="font-size: .875rem;">
                <input type="date" name="close_{{ r.id }}" value="{{ r.close_date or '' }}" style="width:auto; max-width:100px;">
              </td>

              <td style="font-size: .875rem;">
                <select name="status_{{ r.id }}" class="form-select form-select-sm" style="width:93px;">
                  {% for opt in ["Interest", "Entered", "Played", "W/D", "Rank ↓", "Rank ↑"] %}
                    <option value="{{ opt }}" {% if r.status == opt %}selected{% endif %}>
                      {{ opt }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <td style="font-size: .875rem;">
                <input
                  type="number"
                  class="form-control form-control-sm"
                  name="place_{{ r.id }}"
                  value="{{ r.place if r.place is not none }}"
                  style="width:auto; max-width:50px;"
                />
              </td>

              <!-- Points column with highlight -->
              <td class="{% if r.is_top6 %}fw-bold text-success{% endif %}" style="font-size: .875rem; text-align: center;">
                {{ r.points if r.points is not none else "" }}
              </td>

              <!-- Ranking points column (no highlight) -->
              <td class="{% if r.is_best_ranking_points %}fw-bold text-success{% endif %}" style="font-size: .875rem; text-align: center;">
                {{ r.ranking_points }}
              </td>

              <td class="{% if r.rank == min_rank %}fw-bold text-success{% endif %}" style="font-size: .875rem; text-align: center;">
                {{ r.rank if r.rank is not none else "" }}
              </td>
              <td style="font-size: .875rem; text-align: center;"
                {% if r.diff is not none %}
                  {% if r.diff > 0 %}class="text-success"{% elif r.diff < 0 %}class="text-danger"{% else %}class="text-warning"{% endif %}
                {% endif %}
              >
                {% if r.diff is not none %}
                  {{ r.diff }}
                {% endif %}
              </td>
              <td style="font-size: .875rem;">
                {% if r.arrow == "up" %}
                  <span class="text-success">↑</span>
                {% elif r.arrow == "down" %}
                  <span class="text-danger">↓</span>
                {% elif r.arrow == "same" %}
                  <span class="text-warning">-</span>
                {% endif %}
              </td>
              <td style="font-size: .875rem;">
                <input
                  type="number"
                  class="form-control form-control-sm text-success"
                  name="won_{{ r.id }}"
                  value="{{ r.won }}"
                  style="width:auto; max-width:40px;"
                />
              </td>
              <td style="font-size: .875rem;">
                <input
                  type="number"
                  class="form-control form-control-sm text-danger"
                  name="lost_{{ r.id }}"
                  value="{{ r.lost }}"
                  style="width:auto; max-width:40px;"
                />
              </td>
              <td style="font-size: .875rem; text-align: center;"
                {% if r.won > r.lost %}class="text-success"
                {% elif r.won < r.lost %}class="text-danger"
                {% endif %}
              >
                {{ r.matches }}
              </td>
              <td style="font-size: .875rem;">
                {% if not r.is_international %}
                  <input type="number" name="event_{{ r.id }}" value="{{ r.event_id or '' }}"
                        style="width:auto; max-width:40px;">
                {% endif %}                
              </td>
              <td style="font-size: 1.5rem; text-align: center;">
                {% if r.event_id %}
                  <a href="{{ url_for('entries', tournament_id=r.tournament_id, event_id=r.event_id) }}" style="text-decoration: none; color: green;">⇲</a>
                {% endif %}
              </td>
              <td style="font-size: .875rem;">
                {% if not r.is_international %}
                  <input type="number" name="draw_{{ r.id }}" value="{{ r.draw_id or '' }}"
                        style="width:auto; max-width:40px;">
                {% endif %}
              </td>
              <td style="font-size: 1.5rem; text-align: center;">
              {% if r.draw_id %}
                <a href="https://ti.tournamentsoftware.com/tournament/{{ r.tournament_id }}/draw/{{ r.draw_id }}" target="_blank" style="text-decoration: none; color: green;">
                  ⇲
                </a>
              {% endif %}
              </td>
              <td style="font-size: .875rem;">
                {% if not r.is_international %}
                  <input type="number" name="player_{{ r.id }}" value="{{ r.player_id or '' }}"
                      style="width:auto; max-width:45px;">
                {% endif %}      
              </td>
              <td style="font-size: 1.5rem; text-align: center;">
                {% if r.player_id %}
                  <a href="{{ url_for('matches', tournament_id=r.tournament_id, player_id=r.player_id) }}"
                    style="text-decoration: none; color: green;">⇲</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
      <div class="d-flex justify-content-end mt-4"> 
        <button type="submit" class="btn btn-sm btn-success"> 
          Save changes 
        </button> 
      </div>
    </div>
  </div>
</form>
<script>
  const dragContainer = document.querySelector('.table-drag-container');

  let isDown = false;
  let startX;
  let scrollLeft;

  dragContainer.addEventListener('mousedown', (e) => {
    isDown = true;
    startX = e.pageX - dragContainer.offsetLeft;
    scrollLeft = dragContainer.scrollLeft;
  });

  dragContainer.addEventListener('mouseleave', () => {
    isDown = false;
  });

  dragContainer.addEventListener('mouseup', () => {
    isDown = false;
  });

  dragContainer.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - dragContainer.offsetLeft;
    const walk = (x - startX); // scroll speed multiplier
    dragContainer.scrollLeft = scrollLeft - walk;
  });
</script>

<script>
function toggleEdit(el) {
  const cell = el.closest('td');
  const display = cell.querySelector('.date-display');
  const input = cell.querySelector('.date-edit');

  if (el.classList.contains('date-display')) {
    // Switch to input
    display.classList.add('d-none');
    input.classList.remove('d-none');
    input.focus();
  } else {
    // Switch back to display
    display.classList.remove('d-none');
    input.classList.add('d-none');
    // Update display text to new formatted value
    if (input.value) {
      const d = new Date(input.value);
      const options = { weekday: 'short', day: '2-digit', month: '2-digit', year: '2-digit' };
      display.textContent = d.toLocaleDateString('en-GB', options).replace(/\//g, '.');
    }
  }
}
</script>

<script>
function applyFilters() {
    const catFilter = document.getElementById("filter-category").value;
    const statusFilter = document.getElementById("filter-status").value;

    document.querySelectorAll("tbody tr").forEach(row => {
        const rowCat = row.dataset.category;
        const rowStatus = row.dataset.status;

        const catMatch = !catFilter || rowCat === catFilter;
        const statusMatch = !statusFilter || rowStatus === statusFilter;

        row.style.display = (catMatch && statusMatch) ? "" : "none";
    });
}

document.getElementById("filter-category").addEventListener("change", applyFilters);
document.getElementById("filter-status").addEventListener("change", applyFilters);
</script>

</body>
{% endblock %}
