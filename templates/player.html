{% extends "base.html" %}
{% block content %}
<html>  
<head>
    <style>
      /* Move Plotly modebar to bottom of chart */
      .modebar {
        bottom: 0 !important;
        left:10px;
        margin-top: -35px!important;
      }
      .table-green {
        --bs-table-bg: green;
        --bs-table-color: white;
      }
    </style>
  </head>  
<body>  
<!-- Load Plotly globally -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="card-title mb-3">Player Profile</h5>

    <form class="row g-2 mb-3" method="get" action="{{ url_for('player') }}">
      <div class="col-12 col-md-4">
        <label class="form-label">Player name</label>
        <input
          type="text"
          name="name"
          class="form-control"
          value="{{ name }}"
        />
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Ranking Age Group</label>
        <select name="age_group" class="form-select">
          {% for ag in age_groups %}
          <option value="{{ ag }}" {% if ag == age_group %}selected{% endif %}>
            {{ ag }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
      </div>
    </form>
    <div class="alert alert-info mb-3 text-muted">
      Current ranking: <strong>{{ latest_rank if latest_rank else "&mdash;"|safe }}</strong><br>
      Best ranking: <strong>{{ best_rank if best_rank else "&mdash;"|safe }}</strong>
      {% if best_rank_week %} on week <strong>{{ best_rank_week }}</strong>{% endif %}
    </div>
  </div>
</div>
<!-- ✅ Ranking over time chart section -->
{% if plot_json %}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h6 class="card-title mb-3" style="color:white">Ranking Progress</h6>
    <div id="rank-chart"></div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      const fig = {{ plot_json | safe }};
      Plotly.newPlot('rank-chart', fig.data, fig.layout, {responsive: true});
    </script>

  </div>
</div>
{% else %}
<p class="text-muted">No ranking data found for {{ name }} in {{ age_group }}.</p>
{% endif %}

<!-- ✅ Tournament detailed table by category -->
<div class="col-12 mb-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Category Overview ({{ age_group }})</h5>
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-striped mb-0 text-center align-middle">
          <thead class="table-secondary">
            <tr>
              <th>Category</th>
              <th>Tournaments</th>
              <th>Total Points</th>
              <th>Ranking Points</th>
              <th>Best Place</th>
              <th>Best Points</th>
              <th>Won Matches</th>
              <th>Lost Matches</th>
              <th>Total Matches</th>
            </tr>
          </thead>
          <tbody>
            {% for cat, data in category_summary.items() %}
            <tr>
              <td class="fw-bold">{{ cat }}</td>
              <td>{{ "&mdash;"|safe if data.tournaments == 0 else data.tournaments }}</td>
              <td>{{ "&mdash;"|safe if data.total_points == 0 else data.total_points }}</td>
              <td>{{ "&mdash;"|safe if cat_ranking_points.get(cat, 0) == 0 else cat_ranking_points.get(cat, 0) }}</td>
              <td>{{ data.best_place if data.best_place else "&mdash;"|safe }}</td>
              <td>{{ "&mdash;"|safe if data.max_points == 0 else data.max_points }}</td>
              <td>{{ "&mdash;"|safe if data.won == 0 else data.won }}</td>
              <td>{{ "&mdash;"|safe if data.lost == 0 else data.lost }}</td>
              <td>{{ "&mdash;"|safe if data.total == 0 else data.total }}</td>
            </tr>
            {% endfor %}
            <tr class="fw-bold table-green">
              <td style="color:white">Total</td>
              <td style="color:white">{{ grand_total.tournaments }}</td>
              <td style="color:white">{{ grand_total.total_points }}</td>
              <td style="color:white">{{ cat_ranking_points.values()|sum }}</td>
              <td style="color:white">{{ grand_total.best_place if grand_total.best_place else "&mdash;"|safe }}</td>
              <td style="color:white">{{ grand_total.max_points if grand_total.max_points else "&mdash;"|safe }}</td>
              <td style="color:white">{{ grand_total.won }}</td>
              <td style="color:white">{{ grand_total.lost }}</td>
              <td style="color:white">{{ grand_total.total }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Top 6 tournaments bar chart -->
{% if bar_plot_json %}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h6 class="card-title mb-3" style="color:white">Top 6 Tournaments by Points</h6>
    <div id="bar-chart"></div>
    <script>
      const barFig = {{ bar_plot_json | safe }};
      Plotly.newPlot('bar-chart', barFig.data, barFig.layout, {responsive: true});
    </script>
  </div>
</div>
{% else %}
<p class="text-muted">No tournament points found for {{ age_group }}.</p>
{% endif %}

<!-- ✅ Tournament points by category -->
{% if cat_bar_plot_json %}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h6 class="card-title mb-3" style="color:white">Total Points by Category</h6>
    <div id="cat-bar-chart"></div>
    <script>
      const catFig = {{ cat_bar_plot_json | safe }};
      Plotly.newPlot('cat-bar-chart', catFig.data, catFig.layout, {responsive: true});
    </script>
  </div>
</div>
{% endif %}
</body>
</html>
{% endblock %}
